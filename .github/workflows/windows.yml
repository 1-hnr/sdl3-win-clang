name: Build SDL3 (Windows clang-cl)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

env:
  SDL_VERSION: "3.2.28"
  LLVM_PATH: "C:/Program Files/LLVM"

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 初始化 MSVC 环境 (Windows SDK + 运行时)
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # 安装 LLVM 和 Ninja
      - name: Install LLVM and Ninja
        run: |
          choco install llvm ninja -y
          echo "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Append
          echo "C:\ProgramData\chocolatey\bin" | Out-File -FilePath $env:GITHUB_PATH -Append

      # 验证工具链
      - name: Verify toolchain
        run: |
          Write-Host "=== CMake ==="
          cmake --version
          Write-Host ""
          Write-Host "=== Ninja ==="
          & "C:\ProgramData\chocolatey\bin\ninja.exe" --version
          Write-Host ""
          Write-Host "=== Clang ==="
          & "C:\Program Files\LLVM\bin\clang-cl.exe" --version

      # 验证 tag 格式
      - name: Verify tag
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          $tag = "${{ github.ref_name }}"
          if (-not $tag.StartsWith("v${{ env.SDL_VERSION }}+")) {
            Write-Error "Tag must match v${{ env.SDL_VERSION }}+N"
            exit 1
          }

      # CMake 配置
      - name: Configure
        run: |
          cmake -S . -B build -G Ninja `
            "-DCMAKE_MAKE_PROGRAM=C:/ProgramData/chocolatey/bin/ninja.exe" `
            "-DCMAKE_C_COMPILER=C:/Program Files/LLVM/bin/clang-cl.exe" `
            "-DCMAKE_CXX_COMPILER=C:/Program Files/LLVM/bin/clang-cl.exe" `
            "-DCMAKE_TOOLCHAIN_FILE=cmake/toolchain-clang-cl.cmake" `
            "-DCMAKE_BUILD_TYPE=Release" `
            "-DCMAKE_INSTALL_PREFIX=install" `
            "-DSDL3_VERSION=${{ env.SDL_VERSION }}"

      # 构建
      - name: Build
        run: cmake --build build --config Release

      # 安装
      - name: Install
        run: |
          Write-Host "=== Build directory contents ==="
          Get-ChildItem -Path build -Recurse -Include *.dll,*.lib,*.exe | Select-Object FullName
          Write-Host ""
          Write-Host "=== Running cmake install ==="
          cmake --install build --prefix install --verbose
          Write-Host ""
          Write-Host "=== Install directory contents ==="
          if (Test-Path install) {
            Get-ChildItem -Path install -Recurse | Select-Object FullName
          } else {
            Write-Host "Install directory does not exist!"
          }

      # 打包
      - name: Package
        run: |
          if (-not (Test-Path install)) {
            Write-Error "Install directory not found"
            exit 1
          }
          Compress-Archive -Path install\* -DestinationPath sdl3-windows-clang-cl.zip -Force

      # 上传 artifact
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sdl3-windows-clang-cl
          path: sdl3-windows-clang-cl.zip

      # 发布 release
      - name: Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: sdl3-windows-clang-cl.zip
          generate_release_notes: true
