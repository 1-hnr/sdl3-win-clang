name: Build SDL3 (Windows clang-cl)

on:
  push:
    tags:
      - "v*"

env:
  SDL_VERSION: 3.2.1

jobs:
  build:
    runs-on: windows-latest

    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # clang / llvm
      # ------------------------------------------------------------
      - name: Setup LLVM (clang-cl)
        uses: egor-tensin/setup-clang@v1
        with:
          version: latest

      # ------------------------------------------------------------
      # CMake + Ninja (modern, safe)
      # ------------------------------------------------------------
      - name: Setup CMake and Ninja
        uses: lukka/get-cmake@v3.31.6

      # ------------------------------------------------------------
      # Sanity check (optional but useful)
      # ------------------------------------------------------------
      - name: Toolchain versions
        run: |
          cmake --version
          ninja --version
          clang-cl --version

      # ------------------------------------------------------------
      # Tag check (optional)
      # ------------------------------------------------------------
      - name: Verify tag matches SDL version
        shell: pwsh
        run: |
          if (-not "${{ github.ref_name }}".StartsWith("v${{ env.SDL_VERSION }}+")) {
            Write-Error "Tag must be v${{ env.SDL_VERSION }}+<rev>"
          }

      # ------------------------------------------------------------
      # Configure
      # ------------------------------------------------------------
      - name: Configure
        run: >
          cmake -S . -B build
          -G Ninja
          -DCMAKE_TOOLCHAIN_FILE=cmake/toolchain-clang-cl.cmake
          -DCMAKE_BUILD_TYPE=Release

      # ------------------------------------------------------------
      # Build
      # ------------------------------------------------------------
      - name: Build
        run: cmake --build build

      # ------------------------------------------------------------
      # Install
      # ------------------------------------------------------------
      - name: Install
        run: cmake --install build --prefix install

      # ------------------------------------------------------------
      # Package
      # ------------------------------------------------------------
      - name: Package
        run: tar -caf sdl3-windows-clang-cl.zip install

      # ------------------------------------------------------------
      # Release
      # ------------------------------------------------------------
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          files: sdl3-windows-clang-cl.zip
